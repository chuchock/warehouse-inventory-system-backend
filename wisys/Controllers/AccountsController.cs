using System;
using System.Collections.Generic;
using System.IdentityModel.Tokens.Jwt;
using System.Linq;
using System.Net;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using AutoMapper;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using wisys.Data;
using wisys.DTOs;
using wisys.Helpers;

namespace wisys.Controllers
{
	[Route("api/accounts")]
	[ApiController]
	public class AccountsController : ControllerBase
	{
		private readonly UserManager<IdentityUser> _userManager;
		private readonly SignInManager<IdentityUser> _signInManager;
		private readonly IConfiguration _configuration;
		private readonly AppDbContext context;
		private readonly IMapper mapper;

		public AccountsController(
			UserManager<IdentityUser> userManager,
			SignInManager<IdentityUser> signInManager,
			IConfiguration configuration,
			AppDbContext context,
			IMapper mapper)
		{
			_userManager = userManager;
			_signInManager = signInManager;
			_configuration = configuration;
			this.context = context;
			this.mapper = mapper;
		}

		[HttpPost("Create")]
		public async Task<ActionResult<UserToken>> CreateUser([FromBody] UserInfo model)
		{
			var user = new IdentityUser { UserName = model.EmailAddress, Email = model.EmailAddress };
			var result = await _userManager.CreateAsync(user, model.Password);

			if (result.Succeeded)
			{
				return await BuildToken(model);
			}
			else
			{
				return BadRequest(result.Errors);
			}
		}

		[HttpPost("Login")]
		public async Task<ActionResult<UserToken>> Login([FromBody] UserInfo model)
		{
			var result = await _signInManager.PasswordSignInAsync(model.EmailAddress,
				model.Password, isPersistent: false, lockoutOnFailure: false);

			if (result.Succeeded)
			{
				return await BuildToken(model);
			}
			else
			{
				return BadRequest(new { message = "Username or password is incorrect" });
			}
		}

		[HttpPost("RenewToken")]
		[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
		public async Task<ActionResult<UserToken>> Renew()
		{
			var userInfo = new UserInfo
			{
				EmailAddress = HttpContext.User.Identity.Name
			};

			return await BuildToken(userInfo);
		}

		private async Task<UserToken> BuildToken(UserInfo userInfo)
		{
			var claims = new List<Claim>()
			{
				new Claim(ClaimTypes.Name, userInfo.EmailAddress),
				new Claim(ClaimTypes.Email, userInfo.EmailAddress),
				new Claim("mykey", "whatever value I want")
			};

			var identityUser = await _userManager.FindByEmailAsync(userInfo.EmailAddress);
			var claimsDB = await _userManager.GetClaimsAsync(identityUser);

			claims.AddRange(claimsDB);

			var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["jwt:key"]));
			var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

			var expiration = DateTime.UtcNow.AddMinutes(15);

			JwtSecurityToken token = new JwtSecurityToken(
				issuer: null,
				audience: null,
				claims: claims,
				expires: expiration,
				signingCredentials: creds);

			return new UserToken()
			{
				Token = new JwtSecurityTokenHandler().WriteToken(token),
				Expiration = expiration
			};

		}

		[HttpGet("Users")]
		[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme, Roles = "Admin")]
		public async Task<ActionResult<List<UserDTO>>> Get([FromQuery] PaginationDTO paginationDTO)
		{
			var queryable = context.Users.AsQueryable();
			queryable = queryable.OrderBy(x => x.Email);
			await HttpContext.InsertPaginationParametersInResponse(queryable, paginationDTO.RecordsPerPage);
			var users = await queryable.Paginate(paginationDTO).ToListAsync();
			return mapper.Map<List<UserDTO>>(users);
		}

		[HttpGet("Roles")]
		[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme, Roles = "Admin")]
		public async Task<ActionResult<List<string>>> GetRoles()
		{
			return await context.Roles.Select(x => x.Name).ToListAsync();
		}

		[HttpPost("AssignRole")]
		[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme, Roles = "Admin")]
		public async Task<ActionResult> AssignRole(EditRoleDTO editRoleDTO)
		{
			var user = await _userManager.FindByIdAsync(editRoleDTO.UserId);
			if (user == null)
			{
				return NotFound();
			}

			await _userManager.AddClaimAsync(user, new Claim(ClaimTypes.Role, editRoleDTO.RoleName));
			return NoContent();
		}

		[HttpPost("RemoveRole")]
		[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme, Roles = "Admin")]
		public async Task<ActionResult> RemoveRole(EditRoleDTO editRoleDTO)
		{
			var user = await _userManager.FindByIdAsync(editRoleDTO.UserId);
			if (user == null)
			{
				return NotFound();
			}

			await _userManager.RemoveClaimAsync(user, new Claim(ClaimTypes.Role, editRoleDTO.RoleName));
			return NoContent();
		}
	}
}
